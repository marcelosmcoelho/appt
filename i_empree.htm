<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="css/jquery.mobile-1.4.5.min.css" />
<script type="text/javascript" src="cordova.js"></script>
<script type="text/javascript" src="js/mc.js"/></script>

<script src="js/jquery.js"></script>
<script src="js/jquery.mobile-1.4.5.min.js"></script>

</head>

<body>

<script type="text/javascript">

var login = getquerystring("login");
var senha = getquerystring("senha");
var num_empree
var logou;


document.addEventListener("deviceready", onDeviceReady, false);

function onDeviceReady(){
    
if(navigator.connection.type==0 || navigator.connection.type=='none')
 {
	alert('Sem conex�o com internet. Favor se conectar.');
	window.location.assign("ini.htm");
 }
 else
 {
	iniciar() ;
 }
 
}


/////////////////////////////
function iniciar()
{ 
	alert('ponto 0')
    var ajax = new XMLHttpRequest();
    ajax.open("GET","http://www.newdot.com.br/phonegap/app_sc/consult_emp.asp?l=" + login + "&s=" + senha + "&t=" + Math.random(),true);
    ajax.onreadystatechange=function(){
        if(ajax.readyState == 4) {//Request complete !!
            if (ajax.status == 200 || ajax.status == 0) { // OK response
				alert('ponto 1 retorno do consult_emp')
				var resposta_total= ajax.responseText;
				var jsontext=resposta_total.split("*")
				
				var getLogin = JSON.parse(jsontext[0]);
                logou=getLogin.logou;
                qual_id_cliente=getLogin.id_cliente;
                num_empree=getLogin.id_empree;
                nome_empree=getLogin.nome_empree;
                q_e_construtora=getLogin.e_construtora;
                data_implantacao_sc=getLogin.data_implantacao_sc;
                status_sync=getLogin.status_sync;

        
				if (logou=="S") {
					alert('ponto 2: Logou= S')
					var getEmpree = jsontext[1];
					var objEmpree = JSON.parse(getEmpree);

					var db = window.openDatabase("DB_SigmaCivil", "1.0", "DB_SigmaCivil", 200000); //will create database Dummy_DB or open it
				
					///////////////  tabela cliente //////////////
					db.transaction(function (tx) {
						tx.executeSql('CREATE TABLE IF NOT EXISTS mtab_cliente (id_cliente INTEGER, e_construtora TEXT)');
						tx.executeSql('Delete FROM mtab_cliente');
					    tx.executeSql('INSERT INTO mtab_cliente(id_cliente,e_construtora) VALUES (?,?)',[qual_id_cliente,q_e_construtora]);
					/////////////// fim  tabela cliente //////////////

					///////////////  tabela empree //////////////
						tx.executeSql('CREATE TABLE IF NOT EXISTS mtab_empree (id_empree INTEGER, nome_empree TEXT, status_sync TEXT, data_implantacao_sc TEXT)');
						tx.executeSql('Delete FROM mtab_empree');
					    tx.executeSql('INSERT INTO mtab_empree(id_empree,nome_empree,status_sync,data_implantacao_sc) VALUES (?,?,?,?)',[num_empree,nome_empree,status_sync,data_implantacao_sc]);
					/////////////// fim  tabela empree //////////////

					///////////////  tabela programa_manuten��o //////////////
						tx.executeSql('CREATE TABLE IF NOT EXISTS mtab_prog_manut (id_prog_manut INTEGER, nome_sistema TEXT,nome_atividade TEXT, nome_periodicidade TEXT, qtde_agrupamentos_eventos INTEGER, qtde_dias_periodicidade INTEGER, data_inicial_garantia TEXT, formato_periodicidade TEXT)');
						tx.executeSql('Delete FROM mtab_prog_manut');
						for(i=0;i<objEmpree.dados_empreendimento.length;i++){					
							tx.executeSql('INSERT INTO mtab_prog_manut(id_prog_manut,nome_sistema,nome_atividade,nome_periodicidade,qtde_agrupamentos_eventos,qtde_dias_periodicidade,data_inicial_garantia,formato_periodicidade) VALUES (?,?,?,?,?,?,?,?)',[objEmpree.dados_empreendimento[i].id_prog_manut,objEmpree.dados_empreendimento[i].nome_sistema,objEmpree.dados_empreendimento[i].nome_atividade,objEmpree.dados_empreendimento[i].nome_periodicidade,objEmpree.dados_empreendimento[i].qtde_agrupamentos_eventos,objEmpree.dados_empreendimento[i].qtde_dias_periodicidade,objEmpree.dados_empreendimento[i].data_inicial_garantia,objEmpree.dados_empreendimento[i].formato_periodicidade]);
						}				

					///////////////  tabela programa_manuten��o + evento //////////////
						tx.executeSql('CREATE TABLE IF NOT EXISTS mtab_prog_manut_evento (id_prog_manut INTEGER, dia_evento TEXT, mes_evento TEXT, ano_evento TEXT, caminho_imagens TEXT, caminho_audio TEXT, caminho_video TEXT, caminho_texto TEXT, status_imagens_upl TEXT, status_video_upl TEXT , status_audio_upl TEXT, status_texto_upl TEXT)');
						tx.executeSql('Delete FROM mtab_prog_manut_evento');
					
					    go_to()
					});
					///////////////  FIM tabela programa_manuten��o //////////////	        
					
				
				}
				
				else {  //nao logou
             		window.location.assign("login.htm");
				}
			
			}
			else {
			    alert("Problemas com sua conexao internet. Erro: 0145"); 
			}
        }
	}
    ajax.send();
}


function go_to(){
	alert('indo para empree.htm')
  window.location.assign("empree.htm?e=" + num_empree);
}

</script>

</body>
</html>