<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="css/jquery.mobile-1.4.5.min.css" />
<script type="text/javascript" src="cordova.js"></script>
<script type="text/javascript" src="js/mc.js"/></script>

<script src="js/jquery.js"></script>
<script src="js/jquery.mobile-1.4.5.min.js"></script>


</head>

<body>

<script type="text/javascript">


var num_empree = getquerystring("e");

var data_de_hoje=new Date()

var q_mes = getquerystring("qm");
var q_ano = getquerystring("qa");

if (q_mes!='') {
	q_mes=q_mes
}	
else {
   var mes_now= new Date();
   q_mes = mes_now.getMonth()+1;
   q_mes=q_mes.toString()
}

if (q_ano!='') {
	q_ano=q_ano
}	
else {
   var ano_now= new Date();
   q_ano = ano_now.getFullYear();
   q_ano=q_ano.toString()
}


////// variaveis para mes e ano
var marca1=''
var marca2=''
var marca3=''
var marca4=''
var marca5=''
var marca6=''
var marca7=''
var marca8=''
var marca9=''
var marca10=''
var marca11=''
var marca12=''
var marca2010=''
var marca2011=''
var marca2012=''
var marca2013=''
var marca2014=''
var marca2015=''
var marca2016=''
var marca2017=''
var marca2018=''
var marca2019=''
var marca2020=''
var marca2021=''
var marca2022=''

switch (q_mes) {
    case '1':
        marca1 = "selected";
        break;
    case '2':
        marca2 = "selected";
        break;
    case '3':
        marca3 = "selected";
        break;
    case '4':
        marca4 = "selected";
        break;
    case '5':
        marca5 = "selected";
        break;
    case '6':
        marca6 = "selected";
        break;
    case '7':
        marca7 = "selected";
        break;
    case '8':
        marca8 = "selected";
        break;
    case '9':
        marca9 = "selected";
        break;
    case '10':
        marca10 = "selected";
        break;
    case '11':
        marca11 = "selected";
        break;
    case '12':
        marca12 = "selected";
        break;
}

switch (q_ano) {
    case '2010':
        marca2010 = "selected";
        break;
    case '2011':
        marca2011 = "selected";
        break;
    case '2012':
        marca2012 = "selected";
        break;
    case '2013':
        marca2013 = "selected";
        break;
    case '2014':
        marca2014 = "selected";
        break;
    case '2015':
        marca2015 = "selected";
        break;
    case '2016':
        marca2016 = "selected";
        break;
    case '2017':
        marca2017 = "selected";
        break;
    case '2018':
        marca2018 = "selected";
        break;
    case '2019':
        marca2019 = "selected";
        break;
    case '2020':
        marca2020 = "selected";
        break;
    case '2021':
        marca2021 = "selected";
        break;
    case '2022':
        marca2022 = "selected";
        break;
}

////// variaveis para mes e ano

var ini_lista="<ul id='q_empree' data-role='listview' data-inset='true'>"
var fim_lista="</ul>"

var op_periodo=[
'<div align="center">',
'<form name="form1" action="" method="get">',
'<table border="0" cellpadding="0" cellspacing="0">',
 '<tr>',
    '<td ><div align="center">',
		'<div data-role="controlgroup" data-type="horizontal" data-mini="true"  >',
			'<select name="mes" id="idmes">',
				  '<option value="1" ' +  marca1 + ' >Janeiro</option>',
				  '<option value="2" ' +  marca2 + ' >Fevereiro</option>',
				  '<option value="3" ' +    marca3 +'>Mar&ccedil;o</option>',
				  '<option value="4" ' +    marca4 +'>Abril</option>',
				  '<option value="5" ' +    marca5 +'>Maio</option>',
				  '<option value="6" ' +    marca6 +'>Junho</option>',
				  '<option value="7" ' +   marca7 +'>Julho</option>',
				  '<option value="8" ' +    marca8 +'>Agosto</option>',
				  '<option value="9" ' +    marca9 +'>Setembro</option>',
				  '<option value="10" ' +   marca10 +'>Outubro</option>',
				  '<option value="11" ' +   marca11 +'>Novembro</option>',
				  '<option value="12" ' +  marca12 + '>Dezembro</option>',
			'</select>',
			'<select name="ano" id="idano">',
				  '<option value="2010" ' +  marca2010 + '   >2010</option>',
				  '<option value="2011" ' +  marca2011 + '   >2011</option>',
				  '<option value="2012" ' +  marca2012 + '   >2012</option>',
				  '<option value="2013" ' +  marca2013 + '   >2013</option>',
				  '<option value="2014" ' +  marca2014 + '   >2014</option>',
				  '<option value="2015" ' +  marca2015 + '   >2015</option>',
				  '<option value="2016" ' +  marca2016 + '   >2016</option>',
				  '<option value="2017" ' +  marca2017 + '   >2017</option>',
				  '<option value="2018" ' +  marca2018 + '   >2018</option>',
				  '<option value="2019" ' +  marca2019 + '   >2019</option>',
				  '<option value="2020" ' +  marca2020 + '   >2020</option>',
				  '<option value="2021" ' +  marca2021 + '   >2021</option>',
				  '<option value="2022" ' +  marca2022 + '   >2022</option>',
			'</select>',
		'</div>',
	'</div></td>',		
    '<td ><div align="center">',
			'<img src="images/icon_go.gif" id="img1" onClick="enviar()" width="24" height="24" style="cursor:pointer">',
	'</div></td>',		
 '</tr>',
'</table>',
'</form>',
'</div>'
].join('');


document.addEventListener("deviceready", onDeviceReady, false);


function onDeviceReady(){

    var status_sync="";
	
	if(navigator.connection.type==0 || navigator.connection.type=='none')  //checa internet
	 {
		iniciar() ;
	 }
	 else
	 {
          
		   	var resposta_total;  
			var ajax = new XMLHttpRequest();
			ajax.open("GET","http://www.newdot.com.br/phonegap/app_sc/consult_status_sync.asp?e=" + num_empree + "&t=" + Math.random(),true);
			ajax.onreadystatechange=function(){
				if(ajax.readyState == 4) {//Request complete !!
					if (ajax.status == 200 || ajax.status == 0) { // OK response
		
						status_sync_serv= ajax.responseText;
					
						if (status_sync_serv!="nada") {		
					
							var db = window.openDatabase("DB_SigmaCivil", "1.0", "DB_SigmaCivil", 200000); //will create database Dummy_DB or open it
							db.transaction(function (tx) {
								  tx.executeSql('SELECT * FROM mtab_empree'  , [], function (tx, results) {
								    var len = results.rows.length;
								    var row = results.rows.item(0);
								    status_sync=row['status_sync'];
								 						
									if (status_sync_serv==status_sync) {		
										iniciar() ;
									}
									else {
		
										var r = confirm("Houve uma atualização no seu Programa de Manutenção e é necessário sincronizá-lo com este aplicativo. Somente serão apagadas imagens/videos deste app que ainda não foram enviados para o servidor. Confirma a atualização ?");
										if (r == true) {
											window.location.assign("login.htm");
										} else {
										    iniciar() ;
										}
										
									}
								 
								  }, null);
							});										
							
							
						}
						
						else {
						    iniciar() ;
						}
	
					}
										
					else {  // OK response
						alert("Ocorreu um problema com sua conexão internet. Erro: 0570"); 
						iniciar() ;
					}
					
				}
			}
			ajax.send();
	 } //checa internet

}


/////////////////////////////
function iniciar()
{ 

					var menu_sup=[
					'<form name="form_sup" action="" method="get">',
					'<div data-role="header" data-position="fixed" data-theme="a">',
					'<div class="ui-corner-all custom-corners">',
					'<div class="ui-bar ui-bar-a" style="height:38;text-align:center">',
					'<div align="center">',
					  '<table width="30"  border="0" cellpadding="0" cellspacing="0" >',
						'<tr>' ,
						  '<td width="30" ><img src="images/logoSC.gif" width="112" height="35"> </td>',		  
						'</tr>',
					  '</table>',
					'</div>',
					'</div>',
					'</div>',
					'</div>',
					'</form>'
					].join('');

				
					document.getElementById('menu_opc2').innerHTML = menu_sup;
		
					var data1_aux=q_mes + "/01/" + q_ano	
				    var data_ini_p_busca=new Date(data1_aux)

					var q_dia
										
					if (q_mes==04 || q_mes==06 || q_mes==09 || q_mes==11) {
						q_dia=30;									
					} else if ((q_mes==02) && (q_ano % 4 == 0))  {
						q_dia=29;									
					} else if ((q_mes==02) && (q_ano % 4 != 0))  {
						q_dia=28;									
					} else {
						q_dia=31;																			
					}
					
					var data2_aux=q_mes + "/" + q_dia + "/" + q_ano	
	
				    var data_final_p_busca=new Date(data2_aux)
					
					var db = window.openDatabase("DB_SigmaCivil", "1.0", "DB_SigmaCivil", 200000); //will create database Dummy_DB or open it				


					var data_implantacao_sc;
					var nome_empree="";
			
					db.transaction(function (tx) {
					  tx.executeSql('SELECT * FROM mtab_empree', [], function (tx, results) {
					   var len = results.rows.length;
					   var i; 
					   for (i = 0; i < len; i++){
						 var  row = results.rows.item(i)
				         data_implantacao_sc=new Date(row['data_implantacao_sc'])
						 nome_empree=row['nome_empree']
			             document.getElementById('nome_emp').innerHTML = nome_empree;
					   }

							  tx.executeSql('SELECT * FROM mtab_prog_manut ', [], function (tx, results) {
		
							   var len = results.rows.length;
							   var i; 
							   var meio_empree=""; 
							   var final_empree=""; 
							   
							   var qtde_eventos=0;
							   var str=""
							   var str2=""
							   var compl2=""
					   
							   var temp1=""
							   var aux1=""
							   
							   for (i = 0; i < len; i++){
								 var  row = results.rows.item(i)
							   
								 if (num_empree==124 || num_empree==143  || num_empree==139  || num_empree==147 ) {    //depois fazer solucao definitiva
									 auxiliar_dias_garant=19000;
								 }
								 else {
									 auxiliar_dias_garant=1825;
								 }

								 qtde_eventos=parseInt(   auxiliar_dias_garant/(row['qtde_dias_periodicidade']*row['qtde_agrupamentos_eventos'])   )
								  
								 str=row['formato_periodicidade']
								 var data_inicial_garantia=new Date( row['data_inicial_garantia'] )
								 str2=str.split("_")
								 
								 for (j = 1; j <= qtde_eventos; j++){
									 compl2=j*str2[0]*row['qtde_agrupamentos_eventos']  
									 
									 var new_data_evento=new Date(data_inicial_garantia)
									
									 if (str2[1]=="d") {
									    new_data_evento.setDate(new_data_evento.getDate()+compl2);
									 }
									 if (str2[1]=="m") {
									 
										  /////para soma em MESES
										  var inteiro_ano=compl2/12;
										  inteiro_ano=Math.trunc(inteiro_ano);								  
										  var aux_mes=compl2-(12*inteiro_ano);								  
										  aux_mes=(new_data_evento.getMonth()+aux_mes)
										
										  var soma_ano
										  var aux_dia
											
										  if (aux_mes>=12) {
											 aux_mes=aux_mes-12;
											 soma_ano=1;
										  }
										  else {
											 aux_mes=aux_mes;
											 soma_ano=0;
										  }
										  
										  var aux_ano=inteiro_ano+soma_ano
										  aux_ano=(new_data_evento.getFullYear()+aux_ano)
																							  
										 if (new_data_evento.getDate()==31) {																								
										
											if (aux_mes==03 || aux_mes==05 || aux_mes==08 || aux_mes==10) {
												aux_dia=30;									
											} else if ((aux_mes==01) && (aux_ano % 4 == 0))  {
												aux_dia=29;									
											} else if ((aux_mes==01) && (aux_ano % 4 != 0))  {
												aux_dia=28;									
											} else {
												aux_dia=31;																			
											}
											
										 }	else if (new_data_evento.getDate()==30) {																								
										
											if ((aux_mes==01) && (aux_ano % 4 == 0))  {
												aux_dia=29;									
											} else if ((aux_mes==01) && (aux_ano % 4 != 0))  {
												aux_dia=28;									
											} else {
												aux_dia=30;																			
											}
																					
										 } else if (new_data_evento.getDate()==29) {																								
											
											if ((aux_mes==01) && (aux_ano % 4 != 0))  {
												aux_dia=28;									
											} else {
												aux_dia=29;																			
											}
										
										 } else {
											aux_dia=new_data_evento.getDate();
										 }		
										
										 new_data_evento=new Date(aux_ano,aux_mes,aux_dia)
										 /////para soma em MESES
									 
									 }
									 
									 if (str2[1]=="yyyy") {
									    new_data_evento.setFullYear(new_data_evento.getFullYear()+compl2);
									 }
			 
		
									 if (new_data_evento>=data_implantacao_sc) {
		
											 if (new_data_evento>=data_ini_p_busca && new_data_evento<=data_final_p_busca) {
																					
												 var texto_aux
												 if (new_data_evento>data_de_hoje) {
												  texto_aux="faltam " + parseInt( (new_data_evento.getTime()-data_de_hoje.getTime())/(24*3600*1000) ,10)
												  colorAux1="#42B750"									 
												 }
												 else {
												  texto_aux="passados " + parseInt( (data_de_hoje.getTime()-new_data_evento.getTime())/(24*3600*1000) ,10)
												  colorAux1="#D13434"									 
												 }
												  
												 temp1 =new_data_evento.getDate()+ "/" + (new_data_evento.getMonth()+1) + "/" + new_data_evento.getFullYear() + "<br>"
												 aux1="0" + (new_data_evento.getMonth()+1)
												 aux2="0" + (new_data_evento.getDate())
												 meio_empree += "<li><a href='' onClick='ir_para(" + String.fromCharCode(34) + "even.htm?ipm=" + row['id_prog_manut'] + "&dia_ev=" + aux2.substring(aux2.length-2,aux2.length) + "&mes_ev=" + aux1.substring(aux1.length-2,aux1.length) + "&ano_ev=" + new_data_evento.getFullYear() + "" + String.fromCharCode(34) + ")'><table height='3' border='0' cellpadding='0' cellspacing='0'><tr><td><font size='3' face='Arial' color='#000000'>" + row['nome_sistema'] + "</font></td></tr></table><table height='3' border='0' cellpadding='0' cellspacing='0'><tr><td> <font size='2' face='Arial' color='#0033CC'>" + row['nome_atividade'] + "</font></td></tr></table>"  
												 meio_empree += "<table height='3' border='0' cellpadding='0' cellspacing='0'><tr><td></td></tr></table>"
												 meio_empree += "<table height='3' border='0' cellpadding='0' cellspacing='0'><tr><td><font size='2' face='Arial'> (" + row['nome_periodicidade'] + ")</font></td></tr></table>"
												 meio_empree += "<table height='3' border='0' cellpadding='0' cellspacing='0'><tr><td></td></tr></table>"
												 meio_empree += "<table border='0' cellpadding='0' cellspacing='0'><tr><td><div align='center'><font size='3' face='Arial'>" + temp1 + "</font></div></td><td><font size='2' face='Arial' color='" + colorAux1 + "'>&nbsp;- " + texto_aux + " dias </font></td></tr></table>"
												 meio_empree += "</a></li>"				  
											 }
											 
									 }
									 
								 if (new_data_evento>data_final_p_busca) { break; }															  
								 } //for next
		
							   }
							   
							   final_empree= ini_lista + meio_empree + fim_lista
							   document.getElementById('lista_empree').innerHTML = final_empree;
							   $('#q_empree').listview();
							   
							 }, null);

					 }, null);
					});										
			
}


</script>

    <span id="menu_opc2"></span>
	
	<div align="center">
	  <table  border="0" cellpadding="0" cellspacing="6">
		<tr> 
		  <td > <div align="center"><span id="nome_emp"></span></div>
			</td>
		</tr>
	  </table>
	</div>

	<span id="opc_periodo"></span>

	<span id="lista_empree"></span><br>

    
<div style="top:4" data-role="collapsible" data-collapsed="true" class="ui-btn-right" data-mini="true">
  <h4>Menu</h4>
  <ul data-role="listview" data-mini="true">
    <li><a href="#" onClick="enviar_sync()">Novo Login</a></li>
  </ul>
</div>

</body>
</html>

<script>
   document.getElementById('opc_periodo').innerHTML = op_periodo;
</script>

<script>
function ir_para(qlink) {
window.location.assign(qlink)
}

function enviar() {	
    window.location.assign("empree.htm?e=" + num_empree + "&qm=" + document.getElementById('idmes').value + "&qa=" + document.getElementById('idano').value);
}

function enviar_sync() {

decisao = confirm("Confirma efetuar novo LOGIN ? Será possível se logar novamente em qualquer empreendimento atualizando o Plano de Manutenção");

	if (decisao){	
		document.form_sup.action="del.htm";
		document.form_sup.submit();
	
	} else {
	}
	
}


</script>
